{"version":3,"sources":["../../src/web/WebApplication.js"],"names":[],"mappings":"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","file":"WebApplication.js","sourcesContent":["import Promise from 'bluebird';\nimport express from 'express';\nimport Application from '../common/Application';\nimport PowerstoneServer from '../common/PowerstoneServer';\nimport ManagedServer from '../common/ManagedServer';\nimport WebServerFactory from './WebServerFactory';\nimport Router from '../common/Router';\nimport WebMiddleWareRegistry from './WebMiddleWareRegistry';\nimport WebViewRegistry from './WebViewRegistry';\n\nvar mainWare = ['public', 'method-override', 'morgan',\n    'body-parser', 'cookie-parser', 'session', 'csrf'\n];\nvar subWare = ['public'];\n\nclass WebApplication extends Application {\n\n    run() {\n\n        return super.run().\n        then(() => {\n\n            var app;\n            var config;\n            var loader;\n            var wareOrder;\n            var projects = this.projects.slice();\n            var mountain = [];\n            var mountPoint;\n            var isMain = true;\n            var router;\n\n            projects.unshift(this.main);\n\n            projects.forEach((project) => {\n\n                config = project.getConfiguration();\n                loader = project.getLoader();\n                isMain = project.isMain();\n\n                mountPoint = config.readWithDefaults('mount_point', (isMain) ? '' : (config.readWithDefaults('mount_root', false)) ?\n                    '' : '/' + loader.getDirName());\n\n                wareOrder = (isMain) ?\n                    config.readWithDefaults('middleware', mainWare) :\n                    config.readWithDefaults('middleware', subWare);\n\n                app = (isMain) ?\n                    express() : (config.read('router') === true) ?\n                    express.Router() : express();\n\n                wareOrder.\n                forEach(mware =>\n                    WebMiddleWareRegistry.get(mware)(mountPoint, app, config, loader, project));\n\n                router = new Router(app, config);\n                router.configure(loader.loadFromConf('routes', []), config);\n\n                WebViewRegistry.get(config.readWithDefaults('view_engine', 'nunjucks'))(app, config, loader, project);\n\n                mountain.push({\n                    point: mountPoint,\n                    app: app\n                });\n\n            });\n\n            var mainApp = mountain.shift()['app'];\n            mountain.forEach(mount => mainApp.use(mount.point, mount.app));\n\n            this.server = new ManagedServer(\n                this.config.readWithDefaults('port', process.env.PORT || 3000),\n                this.config.readWithDefaults('host', process.env.HOST || '0.0.0.0'),\n                new PowerstoneServer(\n                    WebServerFactory.create(mainApp, this.config.https)));\n\n            return this.server.start();\n\n        }).\nthen(port => this._events.emit(this.events.STARTED, port, this)).\n        catch(err => this._events.emit(this.events.ERROR, err, this));\n\n\n    }\n\n    shutdown() {\n\n        return this.server.shutdown();\n\n    }\n}\n\nexport default WebApplication\n"]}