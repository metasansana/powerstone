{"version":3,"sources":["../../src/web/WebApplication.js"],"names":[],"mappings":"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","file":"WebApplication.js","sourcesContent":["import Promise from 'bluebird';\nimport express from 'express';\nimport Application from '../Application';\nimport PowerstoneServer from '../PowerstoneServer';\nimport ManagedServer from '../ManagedServer';\nimport WebServerFactory from './WebServerFactory';\nimport Routing from './Routing';\nimport WebMiddleWareRegistry from './WebMiddleWareRegistry';\nimport WebViewRegistry from './WebViewRegistry';\n\nvar mainWare = ['public', 'method-override', 'morgan',\n\t'body-parser', 'cookie-parser', 'session', 'csrf'\n];\nvar subWare = ['public'];\n\nclass WebApplication extends Application {\n\n\trun() {\n\n\t\treturn Application.prototype.run.call(this).\n\t\tthen(() => {\n\n\t\t\tvar app;\n\t\t\tvar config;\n\t\t\tvar loader;\n\t\t\tvar wareOrder;\n\t\t\tvar projects = this.projects.slice();\n\t\t\tvar mountain = [];\n\t\t\tvar mountPoint;\n\t\t\tvar isMain = true;\n\n\t\t\tprojects.unshift(this.main);\n\n\t\t\tprojects.forEach((project) => {\n\n\t\t\t\tconfig = project.getConfiguration();\n\t\t\t\tloader = project.getLoader();\n\t\t\t\tisMain = project.isMain();\n\n\t\t\t\tmountPoint = config.readWithDefaults('mount_point', (isMain) ? '' : (config.readWithDefaults('mount_root', false)) ?\n\t\t\t\t\t'' : '/' + loader.getDirName());\n\n\t\t\t\twareOrder = (isMain) ?\n\t\t\t\t\tconfig.readWithDefaults('middleware', mainWare) :\n\t\t\t\t\tconfig.readWithDefaults('middleware', subWare);\n\n\t\t\t\tapp = (isMain) ?\n\t\t\t\t\texpress() : (config.read('router') === true) ?\n\t\t\t\t\texpress.Router() : express();\n\n\t\t\t\twareOrder.\n\t\t\t\tforEach(mware =>\n\t\t\t\t\tWebMiddleWareRegistry.get(mware)\n\t\t\t\t\t(mountPoint, app, config, loader, project));\n\n\t\t\t\tRouting.configure(app,\n\t\t\t\t\tloader.loadFromConf('routes', []), config);\n\n\t\t\t\tWebViewRegistry.get(config.readWithDefaults('view_engine', 'nunjucks'))\n\t\t\t\t\t(app, config, loader, project);\n\n\t\t\t\tmountain.push({\n\t\t\t\t\tpoint: mountPoint,\n\t\t\t\t\tapp: app\n\t\t\t\t});\n\n\t\t\t});\n\n\t\t\tvar mainApp = mountain.shift()['app'];\n\t\t\tmountain.forEach(mount => mainApp.use(mount.point, mount.app));\n\n\t\t\tthis.server = new ManagedServer(\n\t\t\t\tthis.config.readWithDefaults('port', process.env.PORT || 3000),\n\t\t\t\tthis.config.readWithDefaults('host', process.env.HOST || '0.0.0.0'),\n\t\t\t\tnew PowerstoneServer(\n\t\t\t\t\tWebServerFactory.create(mainApp, this.config.https)));\n\n\n\t\t\treturn this.server.start().\n\t\t\tthen(this.serverStarted);\n\n\t\t});\n\n\t}\n\n\tshutdown() {\n\n\t\treturn this.server.shutdown();\n\n\t}\n}\n\nexport default WebApplication\n\n"]}