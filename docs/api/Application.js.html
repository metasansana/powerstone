<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: Application.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: Application.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var Promise = require('bluebird');

var Loader = require('./Loader');
var Connections = require('./connections/Connections');
var TaskRunner = require('./TaskRunner');

var noop = function () {};

/**
 * flattenRoutes turns the conf/route.json file contents into one flat array.
 * @return {Array}
 */
var flattenRoutes = function (routes) {

    var flat = [];

    routes.forEach(function (route) {

        route.routes.forEach(function (entry) {

            flat.push(entry);

        })
    })

    return flat;

};

/**
 * Application
 * @param {String} path
 */
function Application(path) {

    this.name = 'default';
    this.path = path;
    this.controllers = {};
    this.models = {};
    this.routes = [];
    this.tasks = {};
    this.middleware = {};
    this.loader = new Loader(path);
    this.connections = new Connections();
    this.config = this.loader.loadFromConfWithDefaults('config.json', this._defaultConfig());

}

/**
 * defaultConfig
 */
Application.prototype._defaultConfig = function () {
    return {};
};

/**
 * getModelByName should be overwritten to provide models for queries.
 */
Application.prototype.getModelByName = function (name) {
    throw new Error('getModelByName() must be overwritten before a target can be provided. Target: ' + name + '.');
};

/**
 * run
 * @return {Promise}
 */
Application.prototype.run = function () {

    var self = this;

    self.routes = flattenRoutes(self.loader.loadFromConf('routes.json'));

    if (Array.isArray(self.config.connections))
        self.config.connections.forEach(function (con) {
            return self.connections.create(con.name, con.type, con.options);
        });

    return self.connections.open().
        then(function () {

            return Promise.reduce(['','models', 'controllers', 'tasks', 'queries', 'middleware'],
                function (agg, target) {
                    return self.loader.loadMap(target).
                        then(function (hash) {
                            self[target] = hash;
                        });

                });

        }).
        then(function () {
            return TaskRunner.run();

        });

};

module.exports = Application;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="ManagedServer.html">ManagedServer</a></li><li><a href="PowerStoneError.html">PowerStoneError</a></li><li><a href="PowerstoneServer.html">PowerstoneServer</a></li><li><a href="Runtime.html">Runtime</a></li><li><a href="ServerFactory.html">ServerFactory</a></li><li><a href="UnsupportedMethodError.html">UnsupportedMethodError</a></li></ul><h3>Interfaces</h3><ul><li><a href="Server.html">Server</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Application">Application</a></li><li><a href="global.html#flattenRoutes">flattenRoutes</a></li><li><a href="global.html#WebApplication">WebApplication</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0-dev</a> on Sat Jun 20 2015 11:48:21 GMT-0400 (AST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
