import Property from 'property-seek';
import deepmerge from 'deepmerge';
import fs from 'fs';
import Path from 'path';
import crypto from 'crypto';
import Pool from '../net/Pool';
import PropertyResource from './resource/PropertyResource';
import RequireResource from './resource/RequireResource';
import StringResource from './resource/StringResource';
import SchemeResource from './resource/SchemeResource';

const keys = {
    MODULES: 'power.modules',
    MODULES_PREVENTED: 'power.modules.preventRouting',
    CONNECTIONS: 'power.connections',
    MIDDLEWARE: 'power.app.middleware',
    CONTROLLERS: 'power.app.controllers',
    SECRET: 'power.secret',
    PORT: 'power.port',
    PATH: 'power.routing.root',
    WEB_FRAMEWORK_SETTINGS: 'power.web.framework.settings',
    WEB_VIEWS_ENGINE: 'power.web.views.engine',
    WEB_VIEWS_PATHS: 'power.web.views.paths',
    FILTERS: 'power.filters',
    FILTERS_PARSER_JSON_ENABLED: 'power.filters.parser.json.enabled',
    FILTERS_PARSER_JSON_OPTIONS: 'power.filters.parser.json.options',
    FILTERS_PARSER_URLENCODED_ENABLED: 'power.filters.parser.urlencoded.enabled',
    FILTERS_PARSER_URLENCODED_OPTIONS: 'power.filters.parser.urlencoded.options',
    FILTERS_PARSER_TEXT_ENABLED: 'power.filters.parser.text.enabled',
    FILTERS_PARSER_TEXT_OPTIONS: 'power.filters.parser.text.options',
    FILTERS_PARSER_RAW_ENABLED: 'power.filters.parser.raw.enabled',
    FILTERS_PARSER_RAW_OPTIONS: 'power.filters.parser.raw.options',
    FILTERS_CSRF_ENABLED: 'power.filters.csrf.enabled',
    FILTERS_CSRF_OPTIONS: 'power.filters.csrf.options',
    FILTERS_LOG_ENABLED: 'power.filters.log.enabled',
    FILTERS_LOG_FORMAT: 'power.filters.log.format',
    FILTERS_LOG_OPTIONS: 'power.filters.log.options',
    FILTERS_ASSET_PATHS: 'power.filters.asset.paths',
    FILTERS_ASSET_PATHS_OPTIONS: 'power.filters.asset.options',
    FILTERS_ASSET_DIRECTORY: 'power.filters.asset.directory',
    FILTERS_ASSET_DIRECTORY_OPTIONS: 'power.filters.asset.options',
    FILTERS_SESSION_ENABLED: 'power.filters.session.enabled',
    FILTERS_SESSION_OPTIONS: 'power.filters.session.options',
    FILTERS_SESSION_STORE: 'power.filters.session.store',
    FILTERS_COOKIES_OPTIONS: 'power.filters.cookies.options'

};

const defaults = {
    SECRET: crypto.randomBytes(32).toString('hex')
};

function exists(path) {

    try {
        return fs.statSync(path).isFile();
    } catch (e) {
        return false;
    }
}

/**
 * Configuration provides an api for reading interesting values from a
 * modules configuration.
 * @param {string} dir
 * @param {string} path 
 * @property {object} keys
 * @property {string} path
 * TODO Document the properties of this class properly.
 */
class Configuration {

    constructor(dir, path) {

        this.paths = {
            root: path,
            config: `${ path }/${ dir }/config.js`,
            routes: `${ path }/${ dir }/routes.js`,
            modules: `${ path }/modules`,
            connectors: `${ path }/connectors`,
            filters: `${ path }/filters`,
            middleware: `${ path }/app/middleware`,
            controllers: `${ path }/app/controllers`,
            views: `${ path }/app/views`,
            lib: `${ path }/lib`,
            public: `${ path }/public`
        };

        this.keys = keys;
        this.defaults = defaults;
        this.options = exists(this.paths.config) ? require(this.paths.config) : {};
        this.routes = exists(this.paths.routes) ? require(this.paths.routes) : {};
        this._resources = new SchemeResource(new StringResource());

        this._resources.add('require', new RequireResource());
        this._resources.add('lib', new RequireResource(`${ this.paths.lib }/`));
        this._resources.add('env', new PropertyResource(process.env));
        this._resources.add('pool', new PropertyResource(Pool));
    }

    read(key, defaults, merge) {

        var ret = this.options.hasOwnProperty(key) ? this.options[key] : defaults;

        if (typeof ret === 'string') return this._resources.find(ret);

        if (merge) return deepmerge(merge, ret);

        return ret;
    }

    /**
     * require requires all files in a sub-directory into a single object
     * @param {string} dir The  path.
     * @param {object} merge An optional object functions can be merged into.
     * @param {string} [prefix] A prefix that will be concatenated to the object's keys
     * @returns {Object}
     */
    require(dir, merge, prefix) {

        var files;
        var extensions = extensions || ['.js', '.json'];

        merge = merge || {};

        prefix = prefix || '';
        prefix = prefix ? prefix + '.' : prefix;
        prefix = prefix[0] === '/' ? prefix.replace('/', '') : prefix;
        prefix = prefix.replace(/\//g, '.');

        try {
            files = fs.readdirSync(dir);
        } catch (e) {
            return merge || {};
        }
        if (Array.isArray(files)) files.forEach(pathToFile => {

            if (extensions.indexOf(Path.extname(pathToFile)) < 0) return;

            Property.set(merge, prefix + Path.basename(pathToFile, Path.extname(pathToFile)), require(dir + '/' + pathToFile));
        });

        return merge;
    }

}

Configuration.keys = {
    MODULES: 'modules',
    CONNECTIONS: 'connections',
    MIDDLEWARE: 'middleware',
    FILTERS: 'filters',
    PATH: 'path'
};

export default Configuration;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb21tb24vQ29uZmlndXJhdGlvbi5qcyJdLCJuYW1lcyI6WyJQcm9wZXJ0eSIsImRlZXBtZXJnZSIsImZzIiwiUGF0aCIsImNyeXB0byIsIlBvb2wiLCJQcm9wZXJ0eVJlc291cmNlIiwiUmVxdWlyZVJlc291cmNlIiwiU3RyaW5nUmVzb3VyY2UiLCJTY2hlbWVSZXNvdXJjZSIsImtleXMiLCJNT0RVTEVTIiwiTU9EVUxFU19QUkVWRU5URUQiLCJDT05ORUNUSU9OUyIsIk1JRERMRVdBUkUiLCJDT05UUk9MTEVSUyIsIlNFQ1JFVCIsIlBPUlQiLCJQQVRIIiwiV0VCX0ZSQU1FV09SS19TRVRUSU5HUyIsIldFQl9WSUVXU19FTkdJTkUiLCJXRUJfVklFV1NfUEFUSFMiLCJGSUxURVJTIiwiRklMVEVSU19QQVJTRVJfSlNPTl9FTkFCTEVEIiwiRklMVEVSU19QQVJTRVJfSlNPTl9PUFRJT05TIiwiRklMVEVSU19QQVJTRVJfVVJMRU5DT0RFRF9FTkFCTEVEIiwiRklMVEVSU19QQVJTRVJfVVJMRU5DT0RFRF9PUFRJT05TIiwiRklMVEVSU19QQVJTRVJfVEVYVF9FTkFCTEVEIiwiRklMVEVSU19QQVJTRVJfVEVYVF9PUFRJT05TIiwiRklMVEVSU19QQVJTRVJfUkFXX0VOQUJMRUQiLCJGSUxURVJTX1BBUlNFUl9SQVdfT1BUSU9OUyIsIkZJTFRFUlNfQ1NSRl9FTkFCTEVEIiwiRklMVEVSU19DU1JGX09QVElPTlMiLCJGSUxURVJTX0xPR19FTkFCTEVEIiwiRklMVEVSU19MT0dfRk9STUFUIiwiRklMVEVSU19MT0dfT1BUSU9OUyIsIkZJTFRFUlNfQVNTRVRfUEFUSFMiLCJGSUxURVJTX0FTU0VUX1BBVEhTX09QVElPTlMiLCJGSUxURVJTX0FTU0VUX0RJUkVDVE9SWSIsIkZJTFRFUlNfQVNTRVRfRElSRUNUT1JZX09QVElPTlMiLCJGSUxURVJTX1NFU1NJT05fRU5BQkxFRCIsIkZJTFRFUlNfU0VTU0lPTl9PUFRJT05TIiwiRklMVEVSU19TRVNTSU9OX1NUT1JFIiwiRklMVEVSU19DT09LSUVTX09QVElPTlMiLCJkZWZhdWx0cyIsInJhbmRvbUJ5dGVzIiwidG9TdHJpbmciLCJleGlzdHMiLCJwYXRoIiwic3RhdFN5bmMiLCJpc0ZpbGUiLCJlIiwiQ29uZmlndXJhdGlvbiIsImNvbnN0cnVjdG9yIiwiZGlyIiwicGF0aHMiLCJyb290IiwiY29uZmlnIiwicm91dGVzIiwibW9kdWxlcyIsImNvbm5lY3RvcnMiLCJmaWx0ZXJzIiwibWlkZGxld2FyZSIsImNvbnRyb2xsZXJzIiwidmlld3MiLCJsaWIiLCJwdWJsaWMiLCJvcHRpb25zIiwicmVxdWlyZSIsIl9yZXNvdXJjZXMiLCJhZGQiLCJwcm9jZXNzIiwiZW52IiwicmVhZCIsImtleSIsIm1lcmdlIiwicmV0IiwiaGFzT3duUHJvcGVydHkiLCJmaW5kIiwicHJlZml4IiwiZmlsZXMiLCJleHRlbnNpb25zIiwicmVwbGFjZSIsInJlYWRkaXJTeW5jIiwiQXJyYXkiLCJpc0FycmF5IiwiZm9yRWFjaCIsInBhdGhUb0ZpbGUiLCJpbmRleE9mIiwiZXh0bmFtZSIsInNldCIsImJhc2VuYW1lIl0sIm1hcHBpbmdzIjoiQUFBQSxPQUFPQSxRQUFQLE1BQXFCLGVBQXJCO0FBQ0EsT0FBT0MsU0FBUCxNQUFzQixXQUF0QjtBQUNBLE9BQU9DLEVBQVAsTUFBZSxJQUFmO0FBQ0EsT0FBT0MsSUFBUCxNQUFpQixNQUFqQjtBQUNBLE9BQU9DLE1BQVAsTUFBbUIsUUFBbkI7QUFDQSxPQUFPQyxJQUFQLE1BQWlCLGFBQWpCO0FBQ0EsT0FBT0MsZ0JBQVAsTUFBNkIsNkJBQTdCO0FBQ0EsT0FBT0MsZUFBUCxNQUE0Qiw0QkFBNUI7QUFDQSxPQUFPQyxjQUFQLE1BQTJCLDJCQUEzQjtBQUNBLE9BQU9DLGNBQVAsTUFBMkIsMkJBQTNCOztBQUVBLE1BQU1DLE9BQU87QUFDVEMsYUFBUyxlQURBO0FBRVRDLHVCQUFtQiw4QkFGVjtBQUdUQyxpQkFBYSxtQkFISjtBQUlUQyxnQkFBWSxzQkFKSDtBQUtUQyxpQkFB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RCxDQUVFLE9BQU9ILENBQVAsRUFBVTtBQUNSLG1CQUFPd0IsU0FBUyxFQUFoQjtBQUNIO0FBQ0QsWUFBSVMsTUFBTUMsT0FBTixDQUFjTCxLQUFkLENBQUosRUFDSUEsTUFBTU0sT0FBTixDQUFlQyxVQUFELElBQWdCOztBQUUxQixnQkFBSU4sV0FBV08sT0FBWCxDQUFtQnJGLEtBQUtzRixPQUFMLENBQWFGLFVBQWIsQ0FBbkIsSUFBK0MsQ0FBbkQsRUFBc0Q7O0FBRXREdkYscUJBQVMwRixHQUFULENBQWFmLEtBQWIsRUFBb0JJLFNBQVM1RSxLQUFLd0YsUUFBTCxDQUFjSixVQUFkLEVBQTBCcEYsS0FBS3NGLE9BQUwsQ0FBYUYsVUFBYixDQUExQixDQUE3QixFQUNJbkIsUUFBUWQsTUFBTSxHQUFOLEdBQVlpQyxVQUFwQixDQURKO0FBR0gsU0FQRDs7QUFTSixlQUFPWixLQUFQO0FBQ0g7O0FBaEZlOztBQW9GcEJ2QixjQUFjMUMsSUFBZCxHQUFxQjtBQUNqQkMsYUFBUyxTQURRO0FBRWpCRSxpQkFBYSxhQUZJO0FBR2pCQyxnQkFBWSxZQUhLO0FBSWpCUSxhQUFTLFNBSlE7QUFLakJKLFVBQU07QUFMVyxDQUFyQjs7QUFRQSxlQUFla0MsYUFBZiIsImZpbGUiOiJDb25maWd1cmF0aW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFByb3BlcnR5IGZyb20gJ3Byb3BlcnR5LXNlZWsnO1xuaW1wb3J0IGRlZXBtZXJnZSBmcm9tICdkZWVwbWVyZ2UnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBQYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGNyeXB0byBmcm9tICdjcnlwdG8nO1xuaW1wb3J0IFBvb2wgZnJvbSAnLi4vbmV0L1Bvb2wnO1xuaW1wb3J0IFByb3BlcnR5UmVzb3VyY2UgZnJvbSAnLi9yZXNvdXJjZS9Qcm9wZXJ0eVJlc291cmNlJztcbmltcG9ydCBSZXF1aXJlUmVzb3VyY2UgZnJvbSAnLi9yZXNvdXJjZS9SZXF1aXJlUmVzb3VyY2UnO1xuaW1wb3J0IFN0cmluZ1Jlc291cmNlIGZyb20gJy4vcmVzb3VyY2UvU3RyaW5nUmVzb3VyY2UnO1xuaW1wb3J0IFNjaGVtZVJlc291cmNlIGZyb20gJy4vcmVzb3VyY2UvU2NoZW1lUmVzb3VyY2UnO1xuXG5jb25zdCBrZXlzID0ge1xuICAgIE1PRFVMRVM6ICdwb3dlci5tb2R1bGVzJyxcbiAgICBNT0RVTEVTX1BSRVZFTlRFRDogJ3Bvd2VyLm1vZHVsZXMucHJldmVudFJvdXRpbmcnLFxuICAgIENPTk5FQ1RJT05TOiAncG93ZXIuY29ubmVjdGlvbnMnLFxuICAgIE1JRERMRVdBUkU6ICdwb3dlci5hcHAubWlkZGxld2FyZScsXG4gICAgQ09OVFJPTExFUlM6ICdwb3dlci5hcHAuY29udHJvbGxlcnMnLFxuICAgIFNFQ1JFVDogJ3Bvd2VyLnNlY3JldCcsXG4gICAgUE9SVDogJ3Bvd2VyLnBvcnQnLFxuICAgIFBBVEg6ICdwb3dlci5yb3V0aW5nLnJvb3QnLFxuICAgIFdFQl9GUkFNRVdPUktfU0VUVElOR1M6ICdwb3dlci53ZWIuZnJhbWV3b3JrLnNldHRpbmdzJyxcbiAgICBXRUJfVklFV1NfRU5HSU5FOiAncG93ZXIud2ViLnZpZXdzLmVuZ2luZScsXG4gICAgV0VCX1ZJRVdTX1BBVEhTOiAncG93ZXIud2ViLnZpZXdzLnBhdGhzJyxcbiAgICBGSUxURVJTOiAncG93ZXIuZmlsdGVycycsXG4gICAgRklMVEVSU19QQVJTRVJfSlNPTl9FTkFCTEVEOiAncG93ZXIuZmlsdGVycy5wYXJzZXIuanNvbi5lbmFibGVkJyxcbiAgICBGSUxURVJTX1BBUlNFUl9KU09OX09QVElPTlM6ICdwb3dlci5maWx0ZXJzLnBhcnNlci5qc29uLm9wdGlvbnMnLFxuICAgIEZJTFRFUlNfUEFSU0VSX1VSTEVOQ09ERURfRU5BQkxFRDogJ3Bvd2VyLmZpbHRlcnMucGFyc2VyLnVybGVuY29kZWQuZW5hYmxlZCcsXG4gICAgRklMVEVSU19QQVJTRVJfVVJMRU5DT0RFRF9PUFRJT05TOiAncG93ZXIuZmlsdGVycy5wYXJzZXIudXJsZW5jb2RlZC5vcHRpb25zJyxcbiAgICBGSUxURVJTX1BBUlNFUl9URVhUX0VOQUJMRUQ6ICdwb3dlci5maWx0ZXJzLnBhcnNlci50ZXh0LmVuYWJsZWQnLFxuICAgIEZJTFRFUlNfUEFSU0VSX1RFWFRfT1BUSU9OUzogJ3Bvd2VyLmZpbHRlcnMucGFyc2VyLnRleHQub3B0aW9ucycsXG4gICAgRklMVEVSU19QQVJTRVJfUkFXX0VOQUJMRUQ6ICdwb3dlci5maWx0ZXJzLnBhcnNlci5yYXcuZW5hYmxlZCcsXG4gICAgRklMVEVSU19QQVJTRVJfUkFXX09QVElPTlM6ICdwb3dlci5maWx0ZXJzLnBhcnNlci5yYXcub3B0aW9ucycsXG4gICAgRklMVEVSU19DU1JGX0VOQUJMRUQ6ICdwb3dlci5maWx0ZXJzLmNzcmYuZW5hYmxlZCcsXG4gICAgRklMVEVSU19DU1JGX09QVElPTlM6ICdwb3dlci5maWx0ZXJzLmNzcmYub3B0aW9ucycsXG4gICAgRklMVEVSU19MT0dfRU5BQkxFRDogJ3Bvd2VyLmZpbHRlcnMubG9nLmVuYWJsZWQnLFxuICAgIEZJTFRFUlNfTE9HX0ZPUk1BVDogJ3Bvd2VyLmZpbHRlcnMubG9nLmZvcm1hdCcsXG4gICAgRklMVEVSU19MT0dfT1BUSU9OUzogJ3Bvd2VyLmZpbHRlcnMubG9nLm9wdGlvbnMnLFxuICAgIEZJTFRFUlNfQVNTRVRfUEFUSFM6ICdwb3dlci5maWx0ZXJzLmFzc2V0LnBhdGhzJyxcbiAgICBGSUxURVJTX0FTU0VUX1BBVEhTX09QVElPTlM6ICdwb3dlci5maWx0ZXJzLmFzc2V0Lm9wdGlvbnMnLFxuICAgIEZJTFRFUlNfQVNTRVRfRElSRUNUT1JZOiAncG93ZXIuZmlsdGVycy5hc3NldC5kaXJlY3RvcnknLFxuICAgIEZJTFRFUlNfQVNTRVRfRElSRUNUT1JZX09QVElPTlM6ICdwb3dlci5maWx0ZXJzLmFzc2V0Lm9wdGlvbnMnLFxuICAgIEZJTFRFUlNfU0VTU0lPTl9FTkFCTEVEOiAncG93ZXIuZmlsdGVycy5zZXNzaW9uLmVuYWJsZWQnLFxuICAgIEZJTFRFUlNfU0VTU0lPTl9PUFRJT05TOiAncG93ZXIuZmlsdGVycy5zZXNzaW9uLm9wdGlvbnMnLFxuICAgIEZJTFRFUlNfU0VTU0lPTl9TVE9SRTogJ3Bvd2VyLmZpbHRlcnMuc2Vzc2lvbi5zdG9yZScsXG4gICAgRklMVEVSU19DT09LSUVTX09QVElPTlM6ICdwb3dlci5maWx0ZXJzLmNvb2tpZXMub3B0aW9ucydcblxuXG5cbn07XG5cbmNvbnN0IGRlZmF1bHRzID0ge1xuICAgIFNFQ1JFVDogY3J5cHRvLnJhbmRvbUJ5dGVzKDMyKS50b1N0cmluZygnaGV4Jylcbn07XG5cbmZ1bmN0aW9uIGV4aXN0cyhwYXRoKSB7XG5cbiAgICB0cnkge1xuICAgICAgICByZXR1cm4gZnMuc3RhdFN5bmMocGF0aCkuaXNGaWxlKCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG5cbiAgICB9XG59XG5cblxuLyoqXG4gKiBDb25maWd1cmF0aW9uIHByb3ZpZGVzIGFuIGFwaSBmb3IgcmVhZGluZyBpbnRlcmVzdGluZyB2YWx1ZXMgZnJvbSBhXG4gKiBtb2R1bGVzIGNvbmZpZ3VyYXRpb24uXG4gKiBAcGFyYW0ge3N0cmluZ30gZGlyXG4gKiBAcGFyYW0ge3N0cmluZ30gcGF0aCBcbiAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBrZXlzXG4gKiBAcHJvcGVydHkge3N0cmluZ30gcGF0aFxuICogVE9ETyBEb2N1bWVudCB0aGUgcHJvcGVydGllcyBvZiB0aGlzIGNsYXNzIHByb3Blcmx5LlxuICovXG5jbGFzcyBDb25maWd1cmF0aW9uIHtcblxuICAgIGNvbnN0cnVjdG9yKGRpciwgcGF0aCkge1xuXG4gICAgICAgIHRoaXMucGF0aHMgPSB7XG4gICAgICAgICAgICByb290OiBwYXRoLFxuICAgICAgICAgICAgY29uZmlnOiBgJHtwYXRofS8ke2Rpcn0vY29uZmlnLmpzYCxcbiAgICAgICAgICAgIHJvdXRlczogYCR7cGF0aH0vJHtkaXJ9L3JvdXRlcy5qc2AsXG4gICAgICAgICAgICBtb2R1bGVzOiBgJHtwYXRofS9tb2R1bGVzYCxcbiAgICAgICAgICAgIGNvbm5lY3RvcnM6IGAke3BhdGh9L2Nvbm5lY3RvcnNgLFxuICAgICAgICAgICAgZmlsdGVyczogYCR7cGF0aH0vZmlsdGVyc2AsXG4gICAgICAgICAgICBtaWRkbGV3YXJlOiBgJHtwYXRofS9hcHAvbWlkZGxld2FyZWAsXG4gICAgICAgICAgICBjb250cm9sbGVyczogYCR7cGF0aH0vYXBwL2NvbnRyb2xsZXJzYCxcbiAgICAgICAgICAgIHZpZXdzOiBgJHtwYXRofS9hcHAvdmlld3NgLFxuICAgICAgICAgICAgbGliOiBgJHtwYXRofS9saWJgLFxuICAgICAgICAgICAgcHVibGljOiBgJHtwYXRofS9wdWJsaWNgXG4gICAgICAgIH07XG5cbiAgICAgICAgdGhpcy5rZXlzID0ga2V5cztcbiAgICAgICAgdGhpcy5kZWZhdWx0cyA9IGRlZmF1bHRzO1xuICAgICAgICB0aGlzLm9wdGlvbnMgPSAoZXhpc3RzKHRoaXMucGF0aHMuY29uZmlnKSkgPyByZXF1aXJlKHRoaXMucGF0aHMuY29uZmlnKSA6IHt9O1xuICAgICAgICB0aGlzLnJvdXRlcyA9IChleGlzdHModGhpcy5wYXRocy5yb3V0ZXMpKSA/IHJlcXVpcmUodGhpcy5wYXRocy5yb3V0ZXMpIDoge307XG4gICAgICAgIHRoaXMuX3Jlc291cmNlcyA9IG5ldyBTY2hlbWVSZXNvdXJjZShuZXcgU3RyaW5nUmVzb3VyY2UoKSk7XG5cbiAgICAgICAgdGhpcy5fcmVzb3VyY2VzLmFkZCgncmVxdWlyZScsIG5ldyBSZXF1aXJlUmVzb3VyY2UoKSk7XG4gICAgICAgIHRoaXMuX3Jlc291cmNlcy5hZGQoJ2xpYicsIG5ldyBSZXF1aXJlUmVzb3VyY2UoYCR7dGhpcy5wYXRocy5saWJ9L2ApKTtcbiAgICAgICAgdGhpcy5fcmVzb3VyY2VzLmFkZCgnZW52JywgbmV3IFByb3BlcnR5UmVzb3VyY2UocHJvY2Vzcy5lbnYpKTtcbiAgICAgICAgdGhpcy5fcmVzb3VyY2VzLmFkZCgncG9vbCcsIG5ldyBQcm9wZXJ0eVJlc291cmNlKFBvb2wpKTtcblxuICAgIH1cblxuICAgIHJlYWQoa2V5LCBkZWZhdWx0cywgbWVyZ2UpIHtcblxuICAgICAgICB2YXIgcmV0ID0gKHRoaXMub3B0aW9ucy5oYXNPd25Qcm9wZXJ0eShrZXkpKSA/IHRoaXMub3B0aW9uc1trZXldIDogZGVmYXVsdHM7XG5cbiAgICAgICAgaWYgKHR5cGVvZiByZXQgPT09ICdzdHJpbmcnKVxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3Jlc291cmNlcy5maW5kKHJldCk7XG5cbiAgICAgICAgaWYgKG1lcmdlKVxuICAgICAgICAgICAgcmV0dXJuIGRlZXBtZXJnZShtZXJnZSwgcmV0KTtcblxuICAgICAgICByZXR1cm4gcmV0O1xuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogcmVxdWlyZSByZXF1aXJlcyBhbGwgZmlsZXMgaW4gYSBzdWItZGlyZWN0b3J5IGludG8gYSBzaW5nbGUgb2JqZWN0XG4gICAgICogQHBhcmFtIHtzdHJpbmd9IGRpciBUaGUgIHBhdGguXG4gICAgICogQHBhcmFtIHtvYmplY3R9IG1lcmdlIEFuIG9wdGlvbmFsIG9iamVjdCBmdW5jdGlvbnMgY2FuIGJlIG1lcmdlZCBpbnRvLlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbcHJlZml4XSBBIHByZWZpeCB0aGF0IHdpbGwgYmUgY29uY2F0ZW5hdGVkIHRvIHRoZSBvYmplY3QncyBrZXlzXG4gICAgICogQHJldHVybnMge09iamVjdH1cbiAgICAgKi9cbiAgICByZXF1aXJlKGRpciwgbWVyZ2UsIHByZWZpeCkge1xuXG4gICAgICAgIHZhciBmaWxlcztcbiAgICAgICAgdmFyIGV4dGVuc2lvbnMgPSBleHRlbnNpb25zIHx8IFsnLmpzJywgJy5qc29uJ107XG5cbiAgICAgICAgbWVyZ2UgPSBtZXJnZSB8fCB7fTtcblxuICAgICAgICBwcmVmaXggPSBwcmVmaXggfHwgJyc7XG4gICAgICAgIHByZWZpeCA9IChwcmVmaXgpID8gcHJlZml4ICsgJy4nIDogcHJlZml4O1xuICAgICAgICBwcmVmaXggPSAocHJlZml4WzBdID09PSAnLycpID8gcHJlZml4LnJlcGxhY2UoJy8nLCAnJykgOiBwcmVmaXg7XG4gICAgICAgIHByZWZpeCA9IHByZWZpeC5yZXBsYWNlKC9cXC8vZywgJy4nKTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgZmlsZXMgPSBmcy5yZWFkZGlyU3luYyhkaXIpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICByZXR1cm4gbWVyZ2UgfHwge307XG4gICAgICAgIH1cbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZmlsZXMpKVxuICAgICAgICAgICAgZmlsZXMuZm9yRWFjaCgocGF0aFRvRmlsZSkgPT4ge1xuXG4gICAgICAgICAgICAgICAgaWYgKGV4dGVuc2lvbnMuaW5kZXhPZihQYXRoLmV4dG5hbWUocGF0aFRvRmlsZSkpIDwgMCkgcmV0dXJuO1xuXG4gICAgICAgICAgICAgICAgUHJvcGVydHkuc2V0KG1lcmdlLCBwcmVmaXggKyBQYXRoLmJhc2VuYW1lKHBhdGhUb0ZpbGUsIFBhdGguZXh0bmFtZShwYXRoVG9GaWxlKSksXG4gICAgICAgICAgICAgICAgICAgIHJlcXVpcmUoZGlyICsgJy8nICsgcGF0aFRvRmlsZSkpO1xuXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gbWVyZ2U7XG4gICAgfVxuXG59XG5cbkNvbmZpZ3VyYXRpb24ua2V5cyA9IHtcbiAgICBNT0RVTEVTOiAnbW9kdWxlcycsXG4gICAgQ09OTkVDVElPTlM6ICdjb25uZWN0aW9ucycsXG4gICAgTUlERExFV0FSRTogJ21pZGRsZXdhcmUnLFxuICAgIEZJTFRFUlM6ICdmaWx0ZXJzJyxcbiAgICBQQVRIOiAncGF0aCdcbn07XG5cbmV4cG9ydCBkZWZhdWx0IENvbmZpZ3VyYXRpb25cbiJdfQ==