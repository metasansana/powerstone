import Configuration from './Configuration';
import CompositeModule from './CompositeModule';
import PropertyResource from './resource/PropertyResource';
import RequireResource from './resource/RequireResource';
import ModuleResource from './resource/ModuleResource';
import SchemeResource from './resource/SchemeResource';
import Pool from '../net/Pool';
import RouteAction from './route/BulkAction';
import MiddlewareAction from './route/MiddlewareAction';
import ControllerAction from './route/ControllerAction';
import View from './route/View';
import BulkAction from './route/BulkAction';
import UnknownConnectorError from './UnknownConnectorError';
import UnknownFilterError from './UnknownFilterError';
import UnknownModuleError from './UnknownModuleError';

const BASKET = {};
const BOX = [];

/**
 * Module
 * @abstract
 * @param {string} name
 * @param {Configuration} config 
 * @param {object} context 
 * @param {Application} app 
 *
 * @property {string} name
 * @property {Configuration} configuration
 * @property {object} context
 * @property {Application} application
 * @property {CompositeModule} modules
 * @property {string} [configDirectory='apiconf']
 */
class Module {

    constructor(name, config, context, app) {

        this.name = name;
        this.configuration = config;
        this.context = context;
        this.application = app;
        this.modules = new CompositeModule([]);
        this.configDirectory = 'apiconf';
    }

    /**
     * __viewCallback provides a callback that will 
     * handle view declarations.
     * @param {string} view The view template
     * @abstract
     */
    __viewCallback(view) {}

    /**
     * __init initializes this module and its submodules
     */
    __init() {

        var submodule;
        var resource = new SchemeResource(new ModuleResource(this));

        var submodules = this.configuration.read(this.configuration.keys.MODULES, BOX);

        var prevented = this.configuration.read(this.configuration.keys.MODULES_PREVENTED, BOX);

        resource.add('require', new RequireResource());

        submodules.forEach(path => {

            submodule = resource.find(path);

            if (!submodule) throw new UnknownModuleError(path);

            if (prevented.indexOf(submodule.name) > -1) submodule.preventRouting();

            this.modules.add(submodule);
        });

        this.modules.__init();
    }

    /**
     * __autoload the autoloadable aspects of the system
     */
    __autoload() {

        var resource = new SchemeResource(new RequireResource());
        var autoloads;
        var autokey;
        var key;

        var o = {};
        o[this.configuration.keys.CONNECTORS] = 'connectors';
        o[this.configuration.keys.FILTERS] = 'filters';
        o[this.configuration.keys.MIDDLEWARE] = 'middleware';
        o[this.configuration.keys.CONTROLLERS] = 'controllers';

        resource.add('require', new RequireResource());

        [this.configuration.keys.CONNECTORS, this.configuration.keys.FILTERS, this.configuration.keys.MIDDLEWARE, this.configuration.keys.CONTROLLERS].forEach(prefixedKey => {

            key = o[prefixedKey];
            autokey = `power.autoload.${ key }`;
            autoloads = this.configuration.read(autokey, BASKET);

            Object.keys(autoloads).forEach(name => this.context[key][name] = resource.find(autoloads[autokey]));

            this.configuration.require(this.configuration.paths[key], this.context[key]);
        });

        this.modules.__autoload();
    }

    /**
     * __framework performs framework specific actions
     * @abstract
     */
    __framework() {}

    /**
     * __connections establishes the connections decleared in the config file.
     * @return {array<Promise>}
     */
    __connections() {

        var config;
        var connector;
        var connections = this.configuration.read(this.configuration.keys.CONNECTIONS, BASKET);
        var resource = new PropertyResource(this.context.connectors);

        return Object.keys(connections).map(key => {

            config = connections[key];
            connector = resource.find(config.connector);

            if (!connector) throw new UnknownConnectorError(key, config.connector, this.context.connectors);

            if (typeof connector !== 'function') throw new TypeError(`Connector must be a function got '${ typeof connector }'!`);

            return connector(config.options).then(c => Pool[key] = c);
        }).concat(this.modules.__connections());
    }

    /**
     * __filters loads the pre routing middleware.
     */
    __filters(app, defaults) {

        var resource = new SchemeResource(new PropertyResource(this.context.filters));

        resource.add('require', new RequireResource());
        app.use(this.handleRequest.bind(this));

        this.configuration.read(this.configuration.keys.FILTERS, defaults).forEach(f => {

            var filter = resource.find(f);

            if (!filter) throw new UnknownFilterError(this.name, f);

            filter.apply(app, this.configuration);
        });

        this.modules.__filters(app, ['public']);
    }

    /**
     * __routing sets up the routing for this module
     * @param {string} point The mount point of this module's parent's router.
     * @param {FrameworkApplication} app 
     * @param {array<Action>} actions 
     * @abstract
     */
    __routing(mountPoint, app, actions) {}

    /**
     * preventRouting disables routing for this module.
     * Filters will still be applied but the chain will be blocked there.
     */
    preventRouting() {}

    /**
     * handleRequest is called before any of the routes for this
     * module are activated.
     * @param {Request} req 
     * @param {Response} res 
     * @param {function} next 
     */
    handleRequest(req, res, next) {

        next();
    }

    /**
     * load this module
     */
    load(app) {

        this.__init();
        this.__autoload();

        return Promise.all(this.__connections()).then(() => this.application.onConnected(Pool)).then(() => {

            this.__filters(app, ['default']);
            this.__framework();
            this.__routing('', app, new BulkAction([new MiddlewareAction(new PropertyResource(this.context.middleware)), new ControllerAction(this.context.controllers), new View(this.viewEngine)]));
        });
    }

}

export default Module;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb21tb24vTW9kdWxlLmpzIl0sIm5hbWVzIjpbIkNvbmZpZ3VyYXRpb24iLCJDb21wb3NpdGVNb2R1bGUiLCJQcm9wZXJ0eVJlc291cmNlIiwiUmVxdWlyZVJlc291cmNlIiwiTW9kdWxlUmVzb3VyY2UiLCJTY2hlbWVSZXNvdXJjZSIsIlBvb2wiLCJSb3V0ZUFjdGlvbiIsIk1pZGRsZXdhcmVBY3Rpb24iLCJDb250cm9sbGVyQWN0aW9uIiwiVmlldyIsIkJ1bGtBY3Rpb24iLCJVbmtub3duQ29ubmVjdG9yRXJyb3IiLCJVbmtub3duRmlsdGVyRXJyb3IiLCJVbmtub3duTW9kdWxlRXJyb3IiLCJCQVNLRVQiLCJCT1giLCJNb2R1bGUiLCJjb25zdHJ1Y3RvciIsIm5hbWUiLCJjb25maWciLCJjb250ZXh0IiwiYXBwIiwiY29uZmlndXJhdGlvbiIsImFwcGxpY2F0aW9uIiwibW9kdWxlcyIsImNvbmZpZ0RpcmVjdG9yeSIsIl9fdmlld0NhbGxiYWNrIiwidmlldyIsIl9faW5pdCIsInN1Ym1vZHVsZSIsInJlc291cmNlIiwic3VibW9kdWxlcyIsInJlYWQiLCJrZXlzIiwiTU9EVUxFUyIsInByZXZlbnRlZCIsIk1PRFVMRVNfUFJFVkVOVEVEIiwiYWRkIiwiZm9yRWFjaCIsInBhdGgiLCJmaW5kIiwiaW5kZXhPZiIsInByZXZlbnRSb3V0aW5nIiwiX19hdXRvbG9hZCIsImF1dG9sb2FkcyIsImF1dG9rZXkiLCJrZXkiLCJvIiwiQ09OTkVDVE9SUyIsIkZJTFRFUlMiLCJNSURETEVXQVJFIiwiQ09OVFJPTExFUlMiLCJwcmVmaXhlZEtleSIsIk9iamVjdCIsInJlcXVpcmUiLCJwYXRocyIsIl9fZnJhbWV3b3JrIiwiX19jb25uZWN0aW9ucyIsImNvbm5lY3RvciIsImNvbm5lY3Rpb25zIiwiQ09OTkVDVElPTlMiLCJjb25uZWN0b3JzIiwibWFwIiwiVHlwZUVycm9yIiwib3B0aW9ucyIsInRoZW4iLCJjIiwiY29uY2F0IiwiX19maWx0ZXJzIiwiZGVmYXVsdHMiLCJmaWx0ZXJzIiwidXNlIiwiaGFuZGxlUmVxdWVzdCIsImJpbmQiLCJmIiwiZmlsdGVyIiwiYXBwbHkiLCJfX3JvdXRpbmciLCJtb3VudFBvaW50IiwiYWN0aW9ucyIsInJlcSIsInJlcyIsIm5leHQiLCJsb2FkIiwiUHJvbWlzZSIsImFsbCIsIm9uQ29ubmVjdGVkIiwibWlkZGxld2FyZSIsImNvbnRyb2xsZXJzIiwidmlld0VuZ2luZSJdLCJtYXBwaW5ncyI6IkFBQUEsT0FBT0EsYUFBUCxNQUEwQixpQkFBMUI7QUFDQSxPQUFPQyxlQUFQLE1BQTRCLG1CQUE1QjtBQUNBLE9BQU9DLGdCQUFQLE1BQTZCLDZCQUE3QjtBQUNBLE9BQU9DLGVBQVAsTUFBNEIsNEJBQTVCO0FBQ0EsT0FBT0MsY0FBUCxNQUEyQiwyQkFBM0I7QUFDQSxPQUFPQyxjQUFQLE1BQTJCLDJCQUEzQjtBQUNBLE9BQU9DLElBQVAsTUFBaUIsYUFBakI7QUFDQSxPQUFPQyxXQUFQLE1BQXdCLG9CQUF4QjtBQUNBLE9BQU9DLGdCQUFQLE1BQTZCLDBCQUE3QjtBQUNBLE9BQU9DLGdCQUFQLE1BQTZCLDBCQUE3QjtBQUNBLE9BQU9DLElBQVAsTUFBaUIsY0FBakI7QUFDQSxPQUFPQyxVQUFQLE1BQXVCLG9CQUF2QjtBQUNBLE9BQU9DLHFCQUFQLE1BQWtDLHlCQUFsQztBQUNBLE9BQU9DLGtCQUFQLE1BQStCLHNCQUEvQjtBQUNBLE9BQU9DLGtCQUFQLE1BQStCLHNCQUEvQjs7QUFFQSxNQUFNQyxTQUFTLEVBQWY7QUFDQSxNQUFNQyxNQUFNLEVBQVo7O0FBRUE7Ozs7Ozs7Ozs7Ozs7OztBQWVBLE1BQU1DLE1BQU4sQ0FBYTs7QUFFVEMsZ0JBQVlDLElBQVosRUFBa0JDLE1BQWxCLEVBQTBCQyxPQUExQixFQUFtQ0MsR0FBbkMsRUFBd0M7O0FBRXBDLGFBQUtILElBQUwsR0FBWUEsSUFBWjtBQUNBLGFBQUtJLGFBQUwsR0FBcUJILE1BQXJCO0FBQ0EsYUFBS0MsT0FBTCxHQUFlQSxPQUFmO0FBQ0EsYUFBS0cs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Q0FBaUIrRCxXQUFqQixDQUE2QmpGLElBQTdCLENBREosRUFFUDRELElBRk8sQ0FFRixNQUFNOztBQUVQLGlCQUFLRyxTQUFMLENBQWUvQyxHQUFmLEVBQW9CLENBQUMsU0FBRCxDQUFwQjtBQUNBLGlCQUFLbUMsV0FBTDtBQUNBLGlCQUFLcUIsU0FBTCxDQUFlLEVBQWYsRUFBbUJ4RCxHQUFuQixFQUF3QixJQUFJWCxVQUFKLENBQWUsQ0FDbkMsSUFBSUgsZ0JBQUosQ0FBcUIsSUFBSU4sZ0JBQUosQ0FBcUIsS0FBS21CLE9BQUwsQ0FBYW1FLFVBQWxDLENBQXJCLENBRG1DLEVBRW5DLElBQUkvRSxnQkFBSixDQUFxQixLQUFLWSxPQUFMLENBQWFvRSxXQUFsQyxDQUZtQyxFQUduQyxJQUFJL0UsSUFBSixDQUFTLEtBQUtnRixVQUFkLENBSG1DLENBQWYsQ0FBeEI7QUFNSCxTQVpNLENBQVA7QUFjSDs7QUExTlE7O0FBOE5iLGVBQWV6RSxNQUFmIiwiZmlsZSI6Ik1vZHVsZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBDb25maWd1cmF0aW9uIGZyb20gJy4vQ29uZmlndXJhdGlvbic7XG5pbXBvcnQgQ29tcG9zaXRlTW9kdWxlIGZyb20gJy4vQ29tcG9zaXRlTW9kdWxlJztcbmltcG9ydCBQcm9wZXJ0eVJlc291cmNlIGZyb20gJy4vcmVzb3VyY2UvUHJvcGVydHlSZXNvdXJjZSc7XG5pbXBvcnQgUmVxdWlyZVJlc291cmNlIGZyb20gJy4vcmVzb3VyY2UvUmVxdWlyZVJlc291cmNlJztcbmltcG9ydCBNb2R1bGVSZXNvdXJjZSBmcm9tICcuL3Jlc291cmNlL01vZHVsZVJlc291cmNlJztcbmltcG9ydCBTY2hlbWVSZXNvdXJjZSBmcm9tICcuL3Jlc291cmNlL1NjaGVtZVJlc291cmNlJztcbmltcG9ydCBQb29sIGZyb20gJy4uL25ldC9Qb29sJztcbmltcG9ydCBSb3V0ZUFjdGlvbiBmcm9tICcuL3JvdXRlL0J1bGtBY3Rpb24nO1xuaW1wb3J0IE1pZGRsZXdhcmVBY3Rpb24gZnJvbSAnLi9yb3V0ZS9NaWRkbGV3YXJlQWN0aW9uJztcbmltcG9ydCBDb250cm9sbGVyQWN0aW9uIGZyb20gJy4vcm91dGUvQ29udHJvbGxlckFjdGlvbic7XG5pbXBvcnQgVmlldyBmcm9tICcuL3JvdXRlL1ZpZXcnO1xuaW1wb3J0IEJ1bGtBY3Rpb24gZnJvbSAnLi9yb3V0ZS9CdWxrQWN0aW9uJztcbmltcG9ydCBVbmtub3duQ29ubmVjdG9yRXJyb3IgZnJvbSAnLi9Vbmtub3duQ29ubmVjdG9yRXJyb3InO1xuaW1wb3J0IFVua25vd25GaWx0ZXJFcnJvciBmcm9tICcuL1Vua25vd25GaWx0ZXJFcnJvcic7XG5pbXBvcnQgVW5rbm93bk1vZHVsZUVycm9yIGZyb20gJy4vVW5rbm93bk1vZHVsZUVycm9yJztcblxuY29uc3QgQkFTS0VUID0ge307XG5jb25zdCBCT1ggPSBbXTtcblxuLyoqXG4gKiBNb2R1bGVcbiAqIEBhYnN0cmFjdFxuICogQHBhcmFtIHtzdHJpbmd9IG5hbWVcbiAqIEBwYXJhbSB7Q29uZmlndXJhdGlvbn0gY29uZmlnIFxuICogQHBhcmFtIHtvYmplY3R9IGNvbnRleHQgXG4gKiBAcGFyYW0ge0FwcGxpY2F0aW9ufSBhcHAgXG4gKlxuICogQHByb3BlcnR5IHtzdHJpbmd9IG5hbWVcbiAqIEBwcm9wZXJ0eSB7Q29uZmlndXJhdGlvbn0gY29uZmlndXJhdGlvblxuICogQHByb3BlcnR5IHtvYmplY3R9IGNvbnRleHRcbiAqIEBwcm9wZXJ0eSB7QXBwbGljYXRpb259IGFwcGxpY2F0aW9uXG4gKiBAcHJvcGVydHkge0NvbXBvc2l0ZU1vZHVsZX0gbW9kdWxlc1xuICogQHByb3BlcnR5IHtzdHJpbmd9IFtjb25maWdEaXJlY3Rvcnk9J2FwaWNvbmYnXVxuICovXG5jbGFzcyBNb2R1bGUge1xuXG4gICAgY29uc3RydWN0b3IobmFtZSwgY29uZmlnLCBjb250ZXh0LCBhcHApIHtcblxuICAgICAgICB0aGlzLm5hbWUgPSBuYW1lO1xuICAgICAgICB0aGlzLmNvbmZpZ3VyYXRpb24gPSBjb25maWc7XG4gICAgICAgIHRoaXMuY29udGV4dCA9IGNvbnRleHQ7XG4gICAgICAgIHRoaXMuYXBwbGljYXRpb24gPSBhcHA7XG4gICAgICAgIHRoaXMubW9kdWxlcyA9IG5ldyBDb21wb3NpdGVNb2R1bGUoW10pO1xuICAgICAgICB0aGlzLmNvbmZpZ0RpcmVjdG9yeSA9ICdhcGljb25mJztcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIF9fdmlld0NhbGxiYWNrIHByb3ZpZGVzIGEgY2FsbGJhY2sgdGhhdCB3aWxsIFxuICAgICAqIGhhbmRsZSB2aWV3IGRlY2xhcmF0aW9ucy5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gdmlldyBUaGUgdmlldyB0ZW1wbGF0ZVxuICAgICAqIEBhYnN0cmFjdFxuICAgICAqL1xuICAgIF9fdmlld0NhbGxiYWNrKHZpZXcpIHtcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIF9faW5pdCBpbml0aWFsaXplcyB0aGlzIG1vZHVsZSBhbmQgaXRzIHN1Ym1vZHVsZXNcbiAgICAgKi9cbiAgICBfX2luaXQoKSB7XG5cbiAgICAgICAgdmFyIHN1Ym1vZHVsZTtcbiAgICAgICAgdmFyIHJlc291cmNlID0gbmV3IFNjaGVtZVJlc291cmNlKG5ldyBNb2R1bGVSZXNvdXJjZSh0aGlzKSk7XG5cbiAgICAgICAgdmFyIHN1Ym1vZHVsZXMgPSB0aGlzLmNvbmZpZ3VyYXRpb24uXG4gICAgICAgIHJlYWQodGhpcy5jb25maWd1cmF0aW9uLmtleXMuTU9EVUxFUywgQk9YKTtcblxuICAgICAgICB2YXIgcHJldmVudGVkID0gdGhpcy5jb25maWd1cmF0aW9uLnJlYWQoXG4gICAgICAgICAgICB0aGlzLmNvbmZpZ3VyYXRpb24ua2V5cy5NT0RVTEVTX1BSRVZFTlRFRCwgQk9YKTtcblxuICAgICAgICByZXNvdXJjZS5hZGQoJ3JlcXVpcmUnLCBuZXcgUmVxdWlyZVJlc291cmNlKCkpO1xuXG4gICAgICAgIHN1Ym1vZHVsZXMuXG4gICAgICAgIGZvckVhY2gocGF0aCA9PiB7XG5cbiAgICAgICAgICAgIHN1Ym1vZHVsZSA9IHJlc291cmNlLmZpbmQocGF0aCk7XG5cbiAgICAgICAgICAgIGlmICghc3VibW9kdWxlKVxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBVbmtub3duTW9kdWxlRXJyb3IocGF0aCk7XG5cbiAgICAgICAgICAgIGlmIChwcmV2ZW50ZWQuaW5kZXhPZihzdWJtb2R1bGUubmFtZSkgPiAtMSlcbiAgICAgICAgICAgICAgICBzdWJtb2R1bGUucHJldmVudFJvdXRpbmcoKTtcblxuICAgICAgICAgICAgdGhpcy5tb2R1bGVzLmFkZChzdWJtb2R1bGUpO1xuXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMubW9kdWxlcy5fX2luaXQoKTtcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIF9fYXV0b2xvYWQgdGhlIGF1dG9sb2FkYWJsZSBhc3BlY3RzIG9mIHRoZSBzeXN0ZW1cbiAgICAgKi9cbiAgICBfX2F1dG9sb2FkKCkge1xuXG4gICAgICAgIHZhciByZXNvdXJjZSA9IG5ldyBTY2hlbWVSZXNvdXJjZShuZXcgUmVxdWlyZVJlc291cmNlKCkpO1xuICAgICAgICB2YXIgYXV0b2xvYWRzO1xuICAgICAgICB2YXIgYXV0b2tleTtcbiAgICAgICAgdmFyIGtleTtcblxuICAgICAgICB2YXIgbyA9IHt9O1xuICAgICAgICBvW3RoaXMuY29uZmlndXJhdGlvbi5rZXlzLkNPTk5FQ1RPUlNdID0gJ2Nvbm5lY3RvcnMnO1xuICAgICAgICBvW3RoaXMuY29uZmlndXJhdGlvbi5rZXlzLkZJTFRFUlNdID0gJ2ZpbHRlcnMnO1xuICAgICAgICBvW3RoaXMuY29uZmlndXJhdGlvbi5rZXlzLk1JRERMRVdBUkVdID0gJ21pZGRsZXdhcmUnO1xuICAgICAgICBvW3RoaXMuY29uZmlndXJhdGlvbi5rZXlzLkNPTlRST0xMRVJTXSA9ICdjb250cm9sbGVycyc7XG5cbiAgICAgICAgcmVzb3VyY2UuYWRkKCdyZXF1aXJlJywgbmV3IFJlcXVpcmVSZXNvdXJjZSgpKTtcblxuICAgICAgICBbXG4gICAgICAgICAgICB0aGlzLmNvbmZpZ3VyYXRpb24ua2V5cy5DT05ORUNUT1JTLFxuICAgICAgICAgICAgdGhpcy5jb25maWd1cmF0aW9uLmtleXMuRklMVEVSUyxcbiAgICAgICAgICAgIHRoaXMuY29uZmlndXJhdGlvbi5rZXlzLk1JRERMRVdBUkUsXG4gICAgICAgICAgICB0aGlzLmNvbmZpZ3VyYXRpb24ua2V5cy5DT05UUk9MTEVSU1xuICAgICAgICBdLlxuICAgICAgICBmb3JFYWNoKHByZWZpeGVkS2V5ID0+IHtcblxuICAgICAgICAgICAga2V5ID0gb1twcmVmaXhlZEtleV07XG4gICAgICAgICAgICBhdXRva2V5ID0gYHBvd2VyLmF1dG9sb2FkLiR7a2V5fWA7XG4gICAgICAgICAgICBhdXRvbG9hZHMgPSB0aGlzLmNvbmZpZ3VyYXRpb24ucmVhZChhdXRva2V5LCBCQVNLRVQpO1xuXG4gICAgICAgICAgICBPYmplY3Qua2V5cyhhdXRvbG9hZHMpLmZvckVhY2gobmFtZSA9PlxuICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dFtrZXldW25hbWVdID0gcmVzb3VyY2UuZmluZChhdXRvbG9hZHNbYXV0b2tleV0pKTtcblxuICAgICAgICAgICAgdGhpcy5jb25maWd1cmF0aW9uLnJlcXVpcmUodGhpcy5jb25maWd1cmF0aW9uLnBhdGhzW2tleV0sIHRoaXMuY29udGV4dFtrZXldKTtcblxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLm1vZHVsZXMuX19hdXRvbG9hZCgpO1xuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogX19mcmFtZXdvcmsgcGVyZm9ybXMgZnJhbWV3b3JrIHNwZWNpZmljIGFjdGlvbnNcbiAgICAgKiBAYWJzdHJhY3RcbiAgICAgKi9cbiAgICBfX2ZyYW1ld29yaygpIHtcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIF9fY29ubmVjdGlvbnMgZXN0YWJsaXNoZXMgdGhlIGNvbm5lY3Rpb25zIGRlY2xlYXJlZCBpbiB0aGUgY29uZmlnIGZpbGUuXG4gICAgICogQHJldHVybiB7YXJyYXk8UHJvbWlzZT59XG4gICAgICovXG4gICAgX19jb25uZWN0aW9ucygpIHtcblxuICAgICAgICB2YXIgY29uZmlnO1xuICAgICAgICB2YXIgY29ubmVjdG9yO1xuICAgICAgICB2YXIgY29ubmVjdGlvbnMgPSB0aGlzLmNvbmZpZ3VyYXRpb24ucmVhZCh0aGlzLmNvbmZpZ3VyYXRpb24ua2V5cy5DT05ORUNUSU9OUywgQkFTS0VUKTtcbiAgICAgICAgdmFyIHJlc291cmNlID0gbmV3IFByb3BlcnR5UmVzb3VyY2UodGhpcy5jb250ZXh0LmNvbm5lY3RvcnMpO1xuXG4gICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhjb25uZWN0aW9ucykuXG4gICAgICAgIG1hcChrZXkgPT4ge1xuXG4gICAgICAgICAgICBjb25maWcgPSBjb25uZWN0aW9uc1trZXldO1xuICAgICAgICAgICAgY29ubmVjdG9yID0gcmVzb3VyY2UuZmluZChjb25maWcuY29ubmVjdG9yKTtcblxuICAgICAgICAgICAgaWYgKCFjb25uZWN0b3IpXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IFVua25vd25Db25uZWN0b3JFcnJvcihrZXksIGNvbmZpZy5jb25uZWN0b3IsIHRoaXMuY29udGV4dC5jb25uZWN0b3JzKTtcblxuICAgICAgICAgICAgaWYgKHR5cGVvZiBjb25uZWN0b3IgIT09ICdmdW5jdGlvbicpXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcihgQ29ubmVjdG9yIG11c3QgYmUgYSBmdW5jdGlvbiBnb3QgJyR7dHlwZW9mIGNvbm5lY3Rvcn0nIWApO1xuXG4gICAgICAgICAgICByZXR1cm4gY29ubmVjdG9yKGNvbmZpZy5vcHRpb25zKS50aGVuKGMgPT4gUG9vbFtrZXldID0gYyk7XG5cbiAgICAgICAgfSkuY29uY2F0KHRoaXMubW9kdWxlcy5fX2Nvbm5lY3Rpb25zKCkpO1xuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogX19maWx0ZXJzIGxvYWRzIHRoZSBwcmUgcm91dGluZyBtaWRkbGV3YXJlLlxuICAgICAqL1xuICAgIF9fZmlsdGVycyhhcHAsIGRlZmF1bHRzKSB7XG5cbiAgICAgICAgdmFyIHJlc291cmNlID0gbmV3IFNjaGVtZVJlc291cmNlKFxuICAgICAgICAgICAgbmV3IFByb3BlcnR5UmVzb3VyY2UodGhpcy5jb250ZXh0LmZpbHRlcnMpKTtcblxuICAgICAgICByZXNvdXJjZS5hZGQoJ3JlcXVpcmUnLCBuZXcgUmVxdWlyZVJlc291cmNlKCkpO1xuICAgICAgICBhcHAudXNlKHRoaXMuaGFuZGxlUmVxdWVzdC5iaW5kKHRoaXMpKTtcblxuICAgICAgICB0aGlzLmNvbmZpZ3VyYXRpb24ucmVhZCh0aGlzLmNvbmZpZ3VyYXRpb24ua2V5cy5GSUxURVJTLCBkZWZhdWx0cykuXG4gICAgICAgIGZvckVhY2goZiA9PiB7XG5cbiAgICAgICAgICAgIHZhciBmaWx0ZXIgPSByZXNvdXJjZS5maW5kKGYpO1xuXG4gICAgICAgICAgICBpZiAoIWZpbHRlcilcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgVW5rbm93bkZpbHRlckVycm9yKHRoaXMubmFtZSwgZik7XG5cbiAgICAgICAgICAgIGZpbHRlci5hcHBseShhcHAsIHRoaXMuY29uZmlndXJhdGlvbik7XG5cbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5tb2R1bGVzLl9fZmlsdGVycyhhcHAsIFsncHVibGljJ10pO1xuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogX19yb3V0aW5nIHNldHMgdXAgdGhlIHJvdXRpbmcgZm9yIHRoaXMgbW9kdWxlXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHBvaW50IFRoZSBtb3VudCBwb2ludCBvZiB0aGlzIG1vZHVsZSdzIHBhcmVudCdzIHJvdXRlci5cbiAgICAgKiBAcGFyYW0ge0ZyYW1ld29ya0FwcGxpY2F0aW9ufSBhcHAgXG4gICAgICogQHBhcmFtIHthcnJheTxBY3Rpb24+fSBhY3Rpb25zIFxuICAgICAqIEBhYnN0cmFjdFxuICAgICAqL1xuICAgIF9fcm91dGluZyhtb3VudFBvaW50LCBhcHAsIGFjdGlvbnMpIHtcblxuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogcHJldmVudFJvdXRpbmcgZGlzYWJsZXMgcm91dGluZyBmb3IgdGhpcyBtb2R1bGUuXG4gICAgICogRmlsdGVycyB3aWxsIHN0aWxsIGJlIGFwcGxpZWQgYnV0IHRoZSBjaGFpbiB3aWxsIGJlIGJsb2NrZWQgdGhlcmUuXG4gICAgICovXG4gICAgcHJldmVudFJvdXRpbmcoKSB7XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBoYW5kbGVSZXF1ZXN0IGlzIGNhbGxlZCBiZWZvcmUgYW55IG9mIHRoZSByb3V0ZXMgZm9yIHRoaXNcbiAgICAgKiBtb2R1bGUgYXJlIGFjdGl2YXRlZC5cbiAgICAgKiBAcGFyYW0ge1JlcXVlc3R9IHJlcSBcbiAgICAgKiBAcGFyYW0ge1Jlc3BvbnNlfSByZXMgXG4gICAgICogQHBhcmFtIHtmdW5jdGlvbn0gbmV4dCBcbiAgICAgKi9cbiAgICBoYW5kbGVSZXF1ZXN0KHJlcSwgcmVzLCBuZXh0KSB7XG5cbiAgICAgICAgbmV4dCgpO1xuXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogbG9hZCB0aGlzIG1vZHVsZVxuICAgICAqL1xuICAgIGxvYWQoYXBwKSB7XG5cbiAgICAgICAgdGhpcy5fX2luaXQoKTtcbiAgICAgICAgdGhpcy5fX2F1dG9sb2FkKCk7XG5cbiAgICAgICAgcmV0dXJuIFByb21pc2UuYWxsKHRoaXMuX19jb25uZWN0aW9ucygpKS5cbiAgICAgICAgdGhlbigoKSA9PiB0aGlzLmFwcGxpY2F0aW9uLm9uQ29ubmVjdGVkKFBvb2wpKS5cbiAgICAgICAgdGhlbigoKSA9PiB7XG5cbiAgICAgICAgICAgIHRoaXMuX19maWx0ZXJzKGFwcCwgWydkZWZhdWx0J10pO1xuICAgICAgICAgICAgdGhpcy5fX2ZyYW1ld29yaygpO1xuICAgICAgICAgICAgdGhpcy5fX3JvdXRpbmcoJycsIGFwcCwgbmV3IEJ1bGtBY3Rpb24oW1xuICAgICAgICAgICAgICAgIG5ldyBNaWRkbGV3YXJlQWN0aW9uKG5ldyBQcm9wZXJ0eVJlc291cmNlKHRoaXMuY29udGV4dC5taWRkbGV3YXJlKSksXG4gICAgICAgICAgICAgICAgbmV3IENvbnRyb2xsZXJBY3Rpb24odGhpcy5jb250ZXh0LmNvbnRyb2xsZXJzKSxcbiAgICAgICAgICAgICAgICBuZXcgVmlldyh0aGlzLnZpZXdFbmdpbmUpXG4gICAgICAgICAgICBdKSk7XG5cbiAgICAgICAgfSk7XG5cbiAgICB9XG5cbn1cblxuZXhwb3J0IGRlZmF1bHQgTW9kdWxlXG4iXX0=