{"version":3,"sources":["../../src/common/Module.js"],"names":[],"mappings":"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","file":"Module.js","sourcesContent":["import CompositeModule from './CompositeModule';\nimport PropertyDelegate from './PropertyDelegate';\nimport RequireDelegate from './RequireDelegate';\nimport SmartResourceDelegate from './SmartResourceDelegate';\nimport Pool from '../net/Pool';\nimport Configuration from './Configuration';\n\n/**\n * Module\n * @abstract\n * @param {string} name\n * @param {Configuration} config \n * @param {object} context \n * @param {Application} app \n *\n * @property {string} name\n * @property {Configuration} configuration\n * @property {object} context\n * @property {Application} application\n * @property {CompositeModule} submodules\n */\nclass Module {\n\n    constructor(name, config, context, app) {\n\n        this.name = name;\n        this.configuration = config;\n        this.context = context;\n        this.application = app;\n        this.submodules = new CompositeModule([]);\n\n    }\n\n    /**\n     * __submodule is called to create a submodule for this module.\n     * @param {Resource} resource \n     * @param {Application} app \n     * @abstract\n     * @returns {Module}\n     */\n    __submodule(resource, app) {\n\n\n    }\n\n    /**\n     * __init initializes this module and its submodules\n     */\n    __init() {\n\n        var module;\n        var resource;\n        var submodules = this.configuration.read(Configuration.keys.MODULES, {});\n        var delegate = new SmartResourceDelegate(new RequireDelegate(this.configuration.paths.modules));\n\n        delegate.add('require', new RequireDelegate());\n\n        Object.keys(submodules).\n        forEach(path => {\n\n            resource = delegate.resolve(path);\n            module = this.__submodule(resource, this.application);\n\n            if (submodules[path] === false)\n                module.preventActions();\n\n            this.submodules.add(module);\n\n        });\n\n        this.submodules.__init();\n\n    }\n\n    /**\n     * __framework performs framework specific actions\n     * @abstract\n     */\n    __framework() {\n\n    }\n\n    /**\n     * __connectors loads the known connectors so that they can\n     * be used when opening connections.\n     */\n    __connectors() {\n\n        var connectors = this.configuration.read(Configuration.keys.CONNECTORS, {});\n        var delegate = new SmartResourceDelegate(\n            new RequireDelegate(this.configuration.paths.connectors));\n\n        delegate.add('require', new RequireDelegate());\n\n        Object.keys(connectors).\n        forEach(key =>\n            this.context.connectors[key] = delegate.lookup(connectors[key]).module);\n\n    }\n\n    /**\n     * __connections establishes the connections decleared in the config file.\n     * @return {array<Promise>}\n     */\n    __connections() {\n\n        var config;\n        var connector;\n        var connections = this.configuration.read(Configuration.keys.CONNECTIONS, {});\n        var delegate = new SmartResourceDelegate(new PropertyDelegate(this.context.connectors));\n\n        return Object.keys(connections).\n        map(key => {\n\n            config = connections[key];\n            connector = delegate.lookup(config.connector).module;\n            return connector(config.options).then(c => Pool[key] = c);\n\n        }).concat(this.submodules.__connections());\n\n    }\n\n    /**\n     * __middleware loads the pre routing middleware.\n     */\n    __middleware() {\n\n        var wares = this.configuration.read(Configuration.keys.MIDDLEWARE, {});\n        var delegate = new SmartResourceDelegate('require',\n            new RequireDelegate(this.configuration.paths.middleware));\n\n        delegate.add('require', new RequireDelegate());\n\n        if (Array.isArray(wares))\n            wares.forEach(m => {\n\n                var resource = delegate.lookup(m);\n\n                if (typeof resource.module !== 'function')\n                    throw new TypeError('Middleware must be a function, got ',\n                        typeof resource.module, '!');\n\n                resource.module.apply(this);\n\n            });\n\n        this.submodules.__middleware();\n\n    }\n\n    /**\n     * __routing sets up the routing for this module\n     * @param {string} point The mount point of this module's parent's router.\n     * @param {Router} parent The router of this module's parent.\n     */\n    __routing(mountPoint, parent) {\n\n        var path = this.configuration.readOrDefault(Configuration.keys.PATH, `/${this.name}`);\n        var routes = this.configuration.readOrDefault(Configuration.keys.ROUTES, {});\n\n        Object.keys(routes).forEach(route => this.router.add(route));\n        this.submodules.__routing(`${point}/${path}`, this.router);\n        parent.use(path, this.router);\n\n    }\n\n    /**\n     * load this module\n     */\n    load() {\n\n        this.__init();\n        this.__connectors();\n        this.__framework();\n\n        return Promise.all(this.__connections()).\n        then(() => this.application.onConnected(Pool)).\n        then(() => {\n\n            this.__middleware();\n\n        });\n\n    }\n\n}\n\nexport default Module\n"]}