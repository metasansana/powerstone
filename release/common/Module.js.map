{"version":3,"sources":["../../src/common/Module.js"],"names":[],"mappings":"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","file":"Module.js","sourcesContent":["import Configuration from './Configuration';\nimport CompositeModule from './CompositeModule';\nimport PropertyResource from './resource/PropertyResource';\nimport RequireResource from './resource/RequireResource';\nimport ModuleResource from './resource/ModuleResource';\nimport SchemeResource from './resource/SchemeResource';\nimport Pool from '../net/Pool';\nimport RouteAction from './route/BulkAction';\nimport MiddlewareAction from './route/MiddlewareAction';\nimport ControllerAction from './route/ControllerAction';\nimport View from './route/View';\nimport BulkAction from './route/BulkAction';\nimport UnknownConnectorError from './UnknownConnectorError';\nimport UnknownFilterError from './UnknownFilterError';\nimport UnknownModuleError from './UnknownModuleError';\n\nconst BASKET = {};\nconst BOX = [];\n\n/**\n * Module\n * @abstract\n * @param {string} name\n * @param {Configuration} config \n * @param {object} context \n * @param {Application} app \n *\n * @property {string} name\n * @property {Configuration} configuration\n * @property {object} context\n * @property {Application} application\n * @property {CompositeModule} modules\n * @property {string} [configDirectory='apiconf']\n */\nclass Module {\n\n    constructor(name, config, context, app) {\n\n        this.name = name;\n        this.configuration = config;\n        this.context = context;\n        this.application = app;\n        this.modules = new CompositeModule([]);\n        this.configDirectory = 'apiconf';\n\n    }\n\n    /**\n     * __viewCallback provides a callback that will \n     * handle view declarations.\n     * @param {string} view The view template\n     * @abstract\n     */\n    __viewCallback(view) {\n\n    }\n\n    /**\n     * __init initializes this module and its submodules\n     */\n    __init() {\n\n        var submodule;\n        var resource = new SchemeResource(new ModuleResource(this));\n\n        var submodules = this.configuration.\n        read(this.configuration.keys.MODULES, BOX);\n\n        var prevented = this.configuration.read(\n            this.configuration.keys.MODULES_PREVENTED, BOX);\n\n        resource.add('require', new RequireResource());\n\n        submodules.\n        forEach(path => {\n\n            submodule = resource.find(path);\n\n            if (!submodule)\n                throw new UnknownModuleError(path);\n\n            if (prevented.indexOf(submodule.name) > -1)\n                submodule.preventRouting();\n\n            this.modules.add(submodule);\n\n        });\n\n        this.modules.__init();\n\n    }\n\n    /**\n     * __autoload the autoloadable aspects of the system\n     */\n    __autoload() {\n\n        var resource = new SchemeResource(new RequireResource());\n        var autoloads;\n        var autokey;\n        var key;\n\n        var o = {};\n        o[this.configuration.keys.CONNECTORS] = 'connectors';\n        o[this.configuration.keys.FILTERS] = 'filters';\n        o[this.configuration.keys.MIDDLEWARE] = 'middleware';\n        o[this.configuration.keys.CONTROLLERS] = 'controllers';\n\n        resource.add('require', new RequireResource());\n\n        [\n            this.configuration.keys.CONNECTORS,\n            this.configuration.keys.FILTERS,\n            this.configuration.keys.MIDDLEWARE,\n            this.configuration.keys.CONTROLLERS\n        ].\n        forEach(prefixedKey => {\n\n            key = o[prefixedKey];\n            autokey = `power.autoload.${key}`;\n            autoloads = this.configuration.read(autokey, BASKET);\n\n            Object.keys(autoloads).forEach(name =>\n                this.context[key][name] = resource.find(autoloads[autokey]));\n\n            this.configuration.require(this.configuration.paths[key], this.context[key]);\n\n        });\n\n        this.modules.__autoload();\n\n    }\n\n    /**\n     * __framework performs framework specific actions\n     * @abstract\n     */\n    __framework() {\n\n    }\n\n    /**\n     * __connections establishes the connections decleared in the config file.\n     * @return {array<Promise>}\n     */\n    __connections() {\n\n        var config;\n        var connector;\n        var connections = this.configuration.read(this.configuration.keys.CONNECTIONS, BASKET);\n        var resource = new PropertyResource(this.context.connectors);\n\n        return Object.keys(connections).\n        map(key => {\n\n            config = connections[key];\n            connector = resource.find(config.connector);\n\n            if (!connector)\n                throw new UnknownConnectorError(key, config.connector, this.context.connectors);\n\n            return connector(config.options).then(c => Pool[key] = c);\n\n        }).concat(this.modules.__connections());\n\n    }\n\n    /**\n     * __filters loads the pre routing middleware.\n     */\n    __filters(app, defaults) {\n\n        var resource = new SchemeResource(\n            new PropertyResource(this.context.filters));\n\n        resource.add('require', new RequireResource());\n        app.use(this.handleRequest.bind(this));\n\n        this.configuration.read(this.configuration.keys.FILTERS, defaults).\n        forEach(f => {\n\n            var filter = resource.find(f);\n\n            if (!filter)\n                throw new UnknownFilterError(this.name, f);\n\n            filter.apply(app, this.configuration);\n\n        });\n\n        this.modules.__filters(app, ['public']);\n\n    }\n\n    /**\n     * __routing sets up the routing for this module\n     * @param {string} point The mount point of this module's parent's router.\n     * @param {FrameworkApplication} app \n     * @param {array<Action>} actions \n     * @abstract\n     */\n    __routing(mountPoint, app, actions) {\n\n\n    }\n\n    /**\n     * preventRouting disables routing for this module.\n     * Filters will still be applied but the chain will be blocked there.\n     */\n    preventRouting() {\n\n    }\n\n    /**\n     * handleRequest is called before any of the routes for this\n     * module are activated.\n     * @param {Request} req \n     * @param {Response} res \n     * @param {function} next \n     */\n    handleRequest(req, res, next) {\n\n        next();\n\n    }\n\n    /**\n     * load this module\n     */\n    load(app) {\n\n        this.__init();\n        this.__autoload();\n\n        return Promise.all(this.__connections()).\n        then(() => this.application.onConnected(Pool)).\n        then(() => {\n\n            this.__filters(app, ['default']);\n            this.__framework();\n            this.__routing('', app, new BulkAction([\n                new MiddlewareAction(new PropertyResource(this.context.middleware)),\n                new ControllerAction(this.context.controllers),\n                new View(this.viewEngine)\n            ]));\n\n        });\n\n    }\n\n}\n\nexport default Module\n"]}