{"version":3,"sources":["../../src/common/Module.js"],"names":[],"mappings":"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","file":"Module.js","sourcesContent":["import CompositeModule from './CompositeModule';\nimport PropertyDelegate from './PropertyDelegate';\nimport RequireDelegate from './RequireDelegate';\nimport SmartResourceDelegate from './SmartResourceDelegate';\nimport Pool from '../net/Pool';\nimport Configuration from './Configuration';\nimport RouteAction from '../route/BulkAction';\nimport MiddlewareAction from '../route/MiddlewareAction';\nimport ControllerAction from '../route/ControllerAction';\nimport ViewAction from '../route/ViewAction';\nimport BulkAction from '../route/BulkAction';\n\n/**\n * Module\n * @abstract\n * @param {string} name\n * @param {Configuration} config \n * @param {object} context \n * @param {Application} app \n *\n * @property {string} name\n * @property {Configuration} configuration\n * @property {object} context\n * @property {Application} application\n * @property {CompositeModule} submodules\n */\nclass Module {\n\n    constructor(name, config, context, app) {\n\n        this.name = name;\n        this.configuration = config;\n        this.context = context;\n        this.application = app;\n        this.submodules = new CompositeModule([]);\n\n    }\n\n    /**\n     * __submodule is called to create a submodule for this module.\n     * @param {Resource} resource \n     * @param {Application} app \n     * @abstract\n     * @returns {Module}\n     */\n    __submodule(resource, app) {\n\n\n    }\n\n    /**\n     * __viewCallback provides a callback that will \n     * handle view declarations.\n     * @param {string} view The view template\n     * @abstract\n     */\n    __viewCallback(view) {\n\n    }\n\n    /**\n     * __init initializes this module and its submodules\n     */\n    __init() {\n\n        var module;\n        var resource;\n        var submodules = this.configuration.read(Configuration.keys.MODULES, {});\n        var delegate = new SmartResourceDelegate(new RequireDelegate(this.configuration.paths.modules));\n\n        delegate.add('require', new RequireDelegate());\n\n        Object.keys(submodules).\n        forEach(path => {\n\n            resource = delegate.resolve(path);\n            module = this.__submodule(resource, this.application);\n\n            if (submodules[path] === false)\n                module.preventActions();\n\n            this.submodules.add(module);\n\n        });\n\n        this.submodules.__init();\n\n    }\n\n    /**\n     * __autoload the autoloadable aspects of the system\n     */\n    __autoload() {\n\n        var autos = this.configuration.read(Configuration.keys.AUTOS, {});\n        var delegate = new SmartResourceDelegate(new RequireDelegate());\n\n        delegate.add('require', new RequireDelegate());\n\n        ['connectors', 'filters', 'middleware', 'controllers'].\n        forEach(key => {\n\n            if (autos.hasOwnProperty(key))\n                Object.keys(autos[key]).forEach(name =>\n                    this.context[key][name] = delegate.lookup(autos[key][name]).module);\n\n            this.configuration.require(this.configuration.paths[key], this.context[key]);\n\n        });\n\n        this.submodules.__autoload();\n\n    }\n\n    /**\n     * __framework performs framework specific actions\n     * @abstract\n     */\n    __framework() {\n\n    }\n\n    /**\n     * __connections establishes the connections decleared in the config file.\n     * @return {array<Promise>}\n     */\n    __connections() {\n\n        var config;\n        var connector;\n        var connections = this.configuration.read(Configuration.keys.CONNECTIONS, {});\n        var delegate = new PropertyDelegate('connector', this.context.connectors);\n\n        return Object.keys(connections).\n        map(key => {\n\n            config = connections[key];\n            connector = delegate.lookup(config.connector).module;\n            return connector(config.options).then(c => Pool[key] = c);\n\n        }).concat(this.submodules.__connections());\n\n    }\n\n    /**\n     * __filters loads the pre routing middleware.\n     */\n    __filters(app, defaults) {\n\n        var wares = this.configuration.read(Configuration.keys.FILTERS, defaults);\n        var delegate = new SmartResourceDelegate(\n            new PropertyDelegate('filter', this.context.filters));\n\n        delegate.add('require', new RequireDelegate());\n        wares.forEach(m => delegate.lookup(m).module.filter(app, this.configuration));\n\n        this.submodules.__filters(app, []);\n\n    }\n\n    /**\n     * __routing sets up the routing for this module\n     * @param {string} point The mount point of this module's parent's router.\n     * @param {FrameworkApplication} app \n     * @param {array<Action>} actions \n     * @abstract\n     */\n    __routing(mountPoint, app, actions) {\n\n\n    }\n\n    /**\n     * handleRoute is called before any of the routes for this\n     * module are activated.\n     * @param {Request} req \n     * @param {Response} res \n     * @param {function} next \n     */\n    handleRoute(req, res, next) {\n\n        next();\n\n    }\n\n    /**\n     * load this module\n     */\n    load(app) {\n\n        this.__init();\n        this.__autoload();\n\n        return Promise.all(this.__connections()).\n        then(() => this.application.onConnected(Pool)).\n        then(() => {\n\n            this.__filters(app, ['default']);\n            this.__framework();\n            this.__routing('', app, new BulkAction([\n                new MiddlewareAction(new PropertyDelegate('middleware', this.context.middleware)),\n                new ControllerAction(this.context.controllers),\n                new ViewAction(this.__viewCallback)\n            ]));\n\n        });\n\n    }\n\n}\n\nexport default Module\n"]}