{"version":3,"sources":["../../src/common/Module.js"],"names":[],"mappings":"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","file":"Module.js","sourcesContent":["import CompositeModule from './CompositeModule';\nimport BulkLookup from './BulkLookup';\nimport Router from './Router';\n\n/**\n * Module\n * @abstract\n * @param {string} name\n * @param {Configuration} config \n * @param {HttpHandler} handler \n * @param {Application} app \n *\n * @property {string} name\n * @property {Configuration} configuration\n * @property {HttpHandler} handler\n * @property {ResourceLookup} resources\n * @property {Router} router\n * @property {Application} application\n * @property {CompositeModule} submodules\n */\nclass Module {\n\n    constructor(name, config, app) {\n\n        this.name = name;\n        this.application = app;\n        this.configuration = config;\n        this.resources = new BulkLookup('require', new RequireLookup(config.path));\n        this.submodules = new CompositeModule([]);\n\n    }\n\n    /**\n     * __submodule is called to create a submodule for this module.\n     * @param {string} name \n     * @param {Configuration} config \n     * @param {Httphandler} handler \n     * @param {Application} app \n     * @abstract\n     * @returns {Module}\n     */\n    __submodule(name, config, handler, app) {\n\n\n    }\n\n    /**\n     * __route is called to construct an appropriate Route instance.\n     * @abstract\n     * @returns {Route}\n     */\n    __route() {\n\n    }\n\n    /**\n     * __init initializes this module and its submodules\n     */\n    __init() {\n\n        this.configuration.readOrDefault(Configuration.keys.MODULES, []).\n        forEach(path => this.submodules.add(\n            this.__submodule(this.resources.lookup(path), this.handler, this.application)));\n\n        this.submodules.__init();\n\n    }\n\n    /**\n     * __connections establishes the connections decleared in the config file.\n     * @param {object} pool \n     * @return {array<Promise>}\n     */\n    __connections(pool) {\n\n        var config;\n        var connector;\n\n        return Object.keys(this.configuration.readOrDefault(Configuration.keys.CONNECTIONS, {})).\n        map(key => {\n\n            config = connections[key];\n            connector = this.resources.lookup(config.connector);\n            return connector(config.options).then(c => pool[key] = c);\n\n        }).concat(this.submodules.connections(pool));\n\n    }\n\n    /**\n     * __middleware loads the pre routing middleware.\n     */\n    __middleware() {\n\n        var wares = this.config.readOrDefault(Configuration.keys.MIDDLEWARE, {});\n\n        if (Array.isArray(wares.load))\n            wares.load.forEach(m => {\n                var resource = this.resources.lookup(m);\n\n                if (typeof resource.module !== 'function')\n                    throw new TypeError('Middleware must be a function, got ',\n                        typeof resource.module, '!');\n\n                resource.module.\n                apply(this, (wares.options) ?\n                    (wares.options[resource.basename]) ? wares.options[resource.basename] : null : null);\n            });\n\n        this.submodules.middleware();\n\n    }\n\n    /**\n     * __routing sets up the routing for this module\n     * @param {string} point The mount point of this module's parent's router.\n     * @param {Router} parent The router of this module's parent.\n     */\n    __routing(mountPoint, parent) {\n      \n        var path = this.configuration.readOrDefault(Configuration.keys.PATH, `/${this.name}`);\n        var routes = this.configuration.readOrDefault(Configuration.keys.ROUTES, {});\n\n        Object.keys(routes).forEach(route => this.router.add(route));\n        this.submodules.__routing(`${point}/${path}`, this.router);\n        parent.use(path, this.router);\n\n    }\n\n}\n\nexport default Module\n"]}